import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Terminal, Zap, Cpu, ArrowDown, Shield, Crosshair, Sparkles, Rocket, Edit, Save, RotateCcw, X, MousePointer2, Play, Pause, Grid, RefreshCw, Trophy, Medal, Flame, Wind, Biohazard, Disc, ChevronRight, ChevronLeft, Settings, Sliders, MessageSquare, BarChart3, AlertTriangle } from 'lucide-react';
import * as THREE from 'three';

// --- Custom Fonts & Styles ---
const FontStyles = () => (
  <style>{`
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@400;600;700&display=swap');
    
    .font-retro { font-family: 'Press Start 2P', cursive; }
    .font-tech { font-family: 'Rajdhani', sans-serif; }
    
    .scanline {
      background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
      background-size: 100% 4px;
      pointer-events: none;
    }
    .scanline-heavy {
      background: linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0) 50%, rgba(0,0,0,0.5) 50%, rgba(0,0,0,0.5));
      background-size: 100% 3px;
      animation: scanline 5s linear infinite;
    }
    
    @keyframes scanline {
      0% { background-position: 0 0; }
      100% { background-position: 0 100%; }
    }

    .old-tv-filter {
      filter: grayscale(100%) contrast(120%) brightness(0.9) sepia(20%);
    }

    .crt-flicker {
      animation: flicker 0.15s infinite;
      pointer-events: none;
    }

    @keyframes flicker {
      0% { opacity: 0.97; }
      50% { opacity: 1; }
      100% { opacity: 0.98; }
    }

    /* Typewriter Cursor */
    .typing-cursor::after {
      content: '|';
      animation: blink 1s step-start infinite;
    }
    @keyframes blink { 50% { opacity: 0; } }

    /* Badge 3D Rotation */
    @keyframes rotateY {
      0% { transform: rotateY(0deg); }
      100% { transform: rotateY(360deg); }
    }
    .animate-spin-y {
      animation: rotateY 4s linear infinite;
    }

    @keyframes blink-text {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }
    
    .animate-blink {
      animation: blink-text 0.5s step-end infinite;
    }

    @keyframes fadeOut {
      0% { opacity: 1; transform: scale(1); }
      85% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(1.05); }
    }
  `}</style>
);

// --- ASSET DATA ---
const CRAB_DEF = { id: 'crab', name: 'COMMANDER', defaultColor: '#a855f7', frame1: [[0,0,1,0,0,0,0,0,1,0,0],[0,0,0,1,0,0,0,1,0,0,0],[0,0,1,1,1,1,1,1,1,0,0],[0,1,1,0,1,1,1,0,1,1,0],[1,1,1,1,1,1,1,1,1,1,1],[1,0,1,1,1,1,1,1,1,0,1],[1,0,1,0,0,0,0,0,1,0,1],[0,0,0,1,1,0,1,1,0,0,0]], frame2: [[0,0,0,1,0,0,0,1,0,0,0],[0,0,1,0,0,0,0,0,1,0,0],[0,0,1,1,1,1,1,1,1,0,0],[0,1,1,0,1,1,1,0,1,1,0],[1,1,1,1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,1,1,1,0],[0,0,1,0,0,0,0,0,1,0,0],[0,1,0,1,1,0,1,1,0,1,0]] };
const SQUID_DEF = { id: 'squid', name: 'INVADER', defaultColor: '#22d3ee', frame1: [[0,0,0,0,1,1,1,0,0,0,0],[0,0,0,1,1,1,1,1,0,0,0],[0,0,1,1,1,1,1,1,1,0,0],[0,1,1,0,1,1,1,0,1,1,0],[1,1,1,1,1,1,1,1,1,1,1],[0,0,1,1,0,0,0,1,1,0,0],[0,1,1,0,1,0,1,0,1,1,0],[1,1,0,0,0,1,0,0,0,1,1]], frame2: [[0,0,0,0,1,1,1,0,0,0,0],[0,0,0,1,1,1,1,1,0,0,0],[0,0,1,1,1,1,1,1,1,0,0],[0,1,1,0,1,1,1,0,1,1,0],[1,1,1,1,1,1,1,1,1,1,1],[0,0,1,1,0,0,0,1,1,0,0],[0,0,1,1,0,1,0,1,1,0,0],[0,0,0,1,1,0,1,1,0,0,0]] };
const OCTOPUS_DEF = { id: 'octopus', name: 'DROID', defaultColor: '#facc15', frame1: [[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,1,1,1,1,0,0,0],[0,1,1,1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1,1,1,1],[1,1,1,0,0,1,1,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1],[0,0,0,1,1,0,0,1,1,0,0],[0,0,1,1,0,1,1,0,1,1,0]], frame2: [[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,1,1,1,1,0,0,0],[0,1,1,1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1,1,1,1],[1,1,1,0,0,1,1,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1],[0,0,1,1,0,0,0,1,1,0,0],[0,1,0,0,0,0,0,0,0,1,0]] };
const UFO_DEF = { id: 'ufo', name: 'MOTHERSHIP', defaultColor: '#ef4444', frame1: [[0,0,0,0,0,1,1,1,1,0,0],[0,0,0,1,1,1,1,1,1,1,0],[0,0,1,1,1,1,1,1,1,1,1],[0,1,1,0,1,1,1,0,1,1,0],[1,1,1,1,1,1,1,1,1,1,1],[0,0,1,1,1,0,0,0,1,0,0],[0,0,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0]], frame2: [[0,0,0,0,0,1,1,1,1,0,0],[0,0,0,1,1,1,1,1,1,1,0],[0,0,1,1,1,1,1,1,1,1,1],[0,1,1,0,1,1,1,0,1,1,0],[1,1,1,1,1,1,1,1,1,1,1],[0,0,0,1,1,1,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0]] };
const GREEN_DEF = { id: 'green_alien', name: 'SCOUT', defaultColor: '#22c55e', frame1: [[0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,1,1,1,0,0,0,0],[0,0,0,1,1,1,1,1,0,0,0],[0,0,1,1,0,1,0,1,1,0,0],[0,1,1,1,1,1,1,1,1,1,0],[0,1,0,1,1,1,1,1,0,1,0],[0,1,0,1,0,0,0,1,0,1,0],[0,0,0,0,1,1,1,0,0,0,0]], frame2: [[0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,1,1,1,0,0,0,0],[0,0,0,1,1,1,1,1,0,0,0],[0,0,1,1,0,1,0,1,1,0,0],[0,1,1,1,1,1,1,1,1,1,0],[0,0,0,1,1,1,1,1,0,0,0],[0,0,1,1,0,0,0,1,1,0,0],[0,1,0,0,0,0,0,0,0,1,0]] };

const DEFAULT_ASSETS = { crab: CRAB_DEF, squid: SQUID_DEF, octopus: OCTOPUS_DEF, ufo: UFO_DEF, green_alien: GREEN_DEF };

// --- BULLET SPRITES ---
const BULLET_SPRITES = {
  red: { // FIRE
    frames: [
      [[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,"#FFFF00","#FFFF00","#FFFF00",0,0],[0,0,"#FFFF00","#FFFF00","#FFFF00",0,0],[0,0,"#FF0000","#FFFF00","#FF0000",0,0],[0,0,0,"#FFFF00","#FF00FF",0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]],
      [[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,"#FFFF00","#FFFF00","#FFFF00","#FFFF00",0,0,0],[0,0,0,"#FFFF00","#FFFF00","#FFFF00","#FFFF00",0,0,0],[0,0,0,"#FFFF00","#FFFF00","#FFFF00","#FFFF00",0,0,0],[0,0,0,"#FF0000","#FFFF00","#FFFF00","#FF0000",0,0,0],[0,0,0,0,"#FF0000","#FF0000","#FF0000",0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0]]
    ]
  },
  green: { // VIRUS
    frames: [
      [[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,"#15803d","#15803d","#15803d",0,0,0,0],[0,0,0,"#15803d","#4ade80","#15803d",0,0,0,0],[0,0,0,"#4ade80","#4ade80","#4ade80",0,0,0,0],[0,0,0,"#4ade80","#dcfce7","#4ade80",0,0,0,0],[0,0,0,0,"#dcfce7",0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0]],
      [[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,"#15803d","#15803d","#15803d","#15803d",0,0,0,0,0],[0,0,0,0,"#15803d","#4ade80","#4ade80","#15803d",0,0,0,0,0],[0,0,0,0,"#4ade80","#4ade80","#4ade80","#4ade80",0,0,0,0,0],[0,0,0,0,"#4ade80","#4ade80","#4ade80","#4ade80",0,0,0,0,0],[0,0,0,0,"#4ade80","#4ade80","#4ade80","#4ade80",0,0,0,0,0],[0,0,0,0,"#15803d","#4ade80","#4ade80",0,0,0,0,0,0],[0,0,0,0,0,"#15803d",0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0]]
    ]
  },
  blue: { // WIND
    frames: [
      [[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,"#0000FF","#00FFFF","#0000FF",0,0,0],[0,0,"#00FFFF","#00FFFF","#00FFFF",0,0,0],[0,0,"#00FFFF","#FFFFFF","#00FFFF",0,0,0],[0,0,0,"#00FFFF",0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],
      [[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,"#0000FF","#0000FF","#0000FF",0,0,0],[0,0,"#0000FF","#00FFFF","#00FFFF",0,0,0],[0,0,"#00FFFF","#FFFFFF","#00FFFF",0,0,0],[0,0,0,"#FFFFFF",0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]]
    ]
  },
  gold: { // GOLD
    frames: [
      [[0,0,0,0,0,0,0,0,0],[0,0,0,"#eab308","#eab308",0,0,0,0],[0,0,"#eab308","#FFFFFF","#eab308","#FFFFFF",0,0,0],[0,0,"#eab308","#eab308","#eab308","#eab308",0,0,0],[0,0,"#FFFFFF","#eab308","#eab308","#eab308",0,0,0],[0,0,0,"#eab308",0,"#eab308",0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0]],
      [[0,0,0,0,0,0,0,0,0,0],[0,0,0,"#eab308","#eab308","#eab308",0,0,0,0],[0,0,0,"#eab308","#eab308","#FFFFFF",0,0,0,0],[0,0,"#eab308","#FFFFFF","#FFFFFF","#eab308","#FFFFFF",0,0,0],[0,0,"#eab308","#eab308","#eab308","#eab308","#eab308",0,0,0],[0,0,"#FFFFFF","#eab308","#eab308","#eab308","#eab308",0,0,0],[0,0,0,"#eab308",0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0]]
    ]
  }
};

// --- IMPACT SPRITES (Visual Effects on Hit) ---
const IMPACT_SPRITES = {
  red: { // FIRE EXPLOSION
    colors: { '#FFFF00': '#fbbf24', '#FF0000': '#ef4444', '#FF00FF': '#ffffff' },
    frames: [
      [
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#0000FF", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#0000FF", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#FF0000", "#FF0000", "#FF00FF", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#0000FF", "#000000", "#FF0000", "#FF0000", "#FFFFFF", "#FF0000", "#FF0000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#FF0000", "#FF0000", "#FFFFFF", "#FF0000", "#FF0000", "#FF0000", "#000000", "#000000", "#0000FF"],
        ["#000000", "#000000", "#000000", "#FF0000", "#FF0000", "#FFFF00", "#FFFFFF", "#FFFFFF", "#FFFF00", "#FF0000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#FF0000", "#FF00FF", "#FFFF00", "#FFFF00", "#FF0000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FF0000", "#FF0000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#0000FF", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"]
      ],
      [
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FF0000", "#FF0000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#0000FF", "#000000", "#000000", "#000000", "#FF0000", "#FF0000", "#FF0000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#FF0000", "#FFFF00", "#FFFF00", "#FF0000", "#FF0000", "#FFFF00", "#FF0000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#FF0000", "#FF0000", "#FFFF00", "#FFFF00", "#FFFF00", "#FF0000", "#FF0000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#FF0000", "#FF0000", "#FFFF00", "#FFFF00", "#FFFF00", "#FF0000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#FFFF00", "#FF0000", "#FF0000", "#FFFFFF", "#FF0000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FF0000", "#FF0000", "#FF0000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#0000FF", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"]
      ]
    ]
  },
  green: { // VIRUS (Remap Blue to Green)
    colors: { '#0000FF': '#166534', '#00FFFF': '#22c55e', '#FFFFFF': '#bbf7d0', '#000000': 0 },
    frames: [
      // 10x12 (From prompt 'Blue Bullet') -> Green
      [
        [0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0],
        [0,0,0,"#0000FF","#0000FF","#0000FF",0,0,0,0],
        [0,0,0,"#0000FF","#00FFFF","#0000FF",0,0,0,0],
        [0,0,0,"#00FFFF","#00FFFF","#00FFFF",0,0,0,0],
        [0,0,0,"#00FFFF","#FFFFFF","#00FFFF",0,0,0,0],
        [0,0,0,0,"#FFFFFF",0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0]
      ],
      // 13x15 (From prompt) -> Green
      [
        [0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,"#0000FF","#0000FF","#0000FF","#0000FF",0,0,0,0,0],
        [0,0,0,0,"#0000FF","#00FFFF","#00FFFF","#0000FF",0,0,0,0,0],
        [0,0,0,0,"#00FFFF","#00FFFF","#00FFFF","#00FFFF",0,0,0,0,0],
        [0,0,0,0,"#00FFFF","#00FFFF","#00FFFF","#00FFFF",0,0,0,0,0],
        [0,0,0,0,"#00FFFF","#00FFFF","#00FFFF","#00FFFF",0,0,0,0,0],
        [0,0,0,0,"#0000FF","#00FFFF","#00FFFF",0,0,0,0,0,0],
        [0,0,0,0,0,"#0000FF",0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0]
      ]
    ]
  },
  gold: { // GOLD (Remap Red/Magenta to Gold/White)
    colors: { '#FF0000': '#f59e0b', '#FF00FF': '#fef3c7', '#FFFFFF': '#ffffff', '#000000': 0 },
    frames: [
      // 9x8
      [
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,"#FF0000","#FF0000",0,0,0,0],
        [0,0,"#FF0000","#FF00FF","#FF0000","#FF00FF",0,0,0],
        [0,0,"#FF0000","#FF0000","#FF0000","#FF0000",0,0,0],
        [0,0,"#FF00FF","#FF0000","#FF0000","#FF0000",0,0,0],
        [0,0,0,"#FF0000",0,"#FF0000",0,0,0],
        [0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0]
      ],
      // 10x9
      [
        [0,0,0,0,0,0,0,0,0,0],
        [0,0,0,"#FF0000","#FF0000","#FF0000",0,0,0,0],
        [0,0,0,"#FF0000","#FF0000","#FF00FF",0,0,0,0],
        [0,0,"#FF0000","#FF00FF","#FF00FF","#FF0000","#FF00FF",0,0,0],
        [0,0,"#FF0000","#FF0000","#FF0000","#FF0000","#FF0000",0,0,0],
        [0,0,"#FF00FF","#FF0000","#FF0000","#FF0000","#FF0000",0,0,0],
        [0,0,0,"#FF0000",0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0]
      ]
    ]
  },
  blue: { // WATER (Remap Multi-color to Blue)
    colors: { '#FF0000': '#1e40af', '#FFFF00': '#3b82f6', '#FF00FF': '#93c5fd', '#FFFFFF': '#ffffff', '#0000FF': '#172554', '#000000': 0 },
    frames: [
      // 20x22 Motion1
      [
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FFFFFF", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#FFFFFF", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FF0000", "#FF0000", "#FF0000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#0000FF", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#FFFFFF", "#000000", "#000000", "#000000", "#000000", "#FF0000", "#FFFF00", "#FF0000", "#FF0000", "#FF00FF", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FF0000", "#FFFF00", "#FFFF00", "#FF0000", "#FF0000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FF0000", "#FF0000", "#FF0000", "#FFFF00", "#FF0000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FF0000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#FF0000", "#FF0000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#FF0000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#0000FF", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#0000FF", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
      ],
      // 21x23 Motion2
      [
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#0000FF", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FFFFFF", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FF0000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FFFF00", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FF0000", "#FF0000", "#FF00FF", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FF0000", "#FF0000", "#FF0000", "#FF0000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FF00FF", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FFFF00", "#FFFF00", "#FFFFFF", "#FFFF00", "#FFFF00", "#FF0000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FF0000", "#FF0000", "#FFFF00", "#FF0000", "#FF0000", "#FF0000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FF0000", "#FF0000", "#FF0000", "#FF0000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#FF0000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#FF0000", "#FFFF00", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#FF0000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#0000FF", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FFFFFF", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
        ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
      ]
    ]
  }
};

// --- VICTORY SPRITE (12x12 Gold Trophy) ---
const VICTORY_SPRITE = [
  [0,0,0,0,0,0,0,0,0,0,0,0],
  [0,1,1,1,1,1,1,1,1,1,1,0], // Gold Rim
  [0,1,1,1,1,1,1,1,1,1,1,0],
  [0,0,1,1,1,1,1,1,1,1,0,0],
  [0,0,0,1,1,1,1,1,1,0,0,0],
  [0,0,0,0,1,1,1,1,0,0,0,0],
  [0,0,0,0,0,1,1,0,0,0,0,0],
  [0,0,0,0,0,1,1,0,0,0,0,0],
  [0,0,0,0,1,1,1,1,0,0,0,0],
  [0,0,0,1,1,1,1,1,1,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0]
];

// --- NEW PLAYER SHIP ASSET (13x14 Color Matrix) ---
const PLAYER_SHIP_DEF = [
  ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
  ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FFFFFF", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
  ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FFFFFF", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
  ["#000000", "#000000", "#000000", "#000000", "#000000", "#FFFFFF", "#00FFFF", "#FFFFFF", "#000000", "#000000", "#000000", "#000000", "#000000"],
  ["#000000", "#000000", "#000000", "#000000", "#000000", "#FFFFFF", "#00FFFF", "#FFFFFF", "#000000", "#000000", "#000000", "#000000", "#000000"],
  ["#000000", "#000000", "#000000", "#000000", "#00FFFF", "#FFFFFF", "#FFFFFF", "#FFFFFF", "#00FFFF", "#000000", "#000000", "#000000", "#000000"],
  ["#000000", "#000000", "#000000", "#00FFFF", "#FFFFFF", "#FFFFFF", "#FFFFFF", "#FFFFFF", "#FFFFFF", "#00FFFF", "#000000", "#000000", "#000000"],
  ["#000000", "#000000", "#FFFFFF", "#FFFFFF", "#FFFFFF", "#FFFFFF", "#FFFFFF", "#FFFFFF", "#FFFFFF", "#FFFFFF", "#FFFFFF", "#000000", "#000000"],
  ["#000000", "#000000", "#FFFFFF", "#FFFFFF", "#FFFFFF", "#FFFFFF", "#FFFFFF", "#FFFFFF", "#FFFFFF", "#FFFFFF", "#FFFFFF", "#000000", "#000000"],
  ["#000000", "#000000", "#FFFFFF", "#000000", "#000000", "#000000", "#FF0000", "#000000", "#000000", "#000000", "#FFFFFF", "#000000", "#000000"],
  ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
  ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FF0000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
  ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#FFFF00", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
  ["#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000"],
];

// DOUBLED SCORE THRESHOLDS for Stage 2
const DEFAULT_BADGES = [
  { score: 2000, id: 'purple_killer', name: 'PURPLE KILLER', color: '#a855f7', iconType: 'single', shapeId: 'crab' },
  { score: 4000, id: 'white_killer', name: 'WHITE KILLER', color: '#ffffff', iconType: 'single', shapeId: 'crab' },
  { score: 6000, id: 'blue_killer', name: 'BLUE KILLER', color: '#22d3ee', iconType: 'single', shapeId: 'squid' },
  { score: 8000, id: 'yellow_killer', name: 'YELLOW KILLER', color: '#facc15', iconType: 'single', shapeId: 'octopus' },
  { score: 10000, id: 'red_killer', name: 'RED KILLER', color: '#ef4444', iconType: 'single', shapeId: 'ufo' },
  { score: 12000, id: 'green_killer', name: 'GREEN KILLER', color: '#22c55e', iconType: 'single', shapeId: 'green_alien' },
  { score: 26000, id: 'golden_killer', name: 'GOLDEN KILLER', color: '#fbbf24', iconType: 'single', shapeId: 'crab' },
  { score: 60000, id: 'super_golden', name: 'SUPER KILLER', color: '#fbbf24', iconType: 'triple', shapeId: 'ufo' },
];

const DEFAULT_WEAPONS = {
  default: { color: '#ffffff', name: 'PLASMA', ammo: Infinity, cooldown: 300 },
  red: { color: '#ef4444', name: 'INFERNO', ammo: 10, cooldown: 100, maxShotsBeforeHeat: 10, heatCoolTime: 1000 },
  green: { color: '#22c55e', name: 'BIOHAZARD', ammo: 4, cooldown: 500 },
  blue: { color: '#22d3ee', name: 'TEMPEST', ammo: 4, cooldown: 1000 },
  gold: { color: '#fbbf24', name: 'PIERCER', ammo: 20, cooldown: 300 },
};

// --- Helper: Pixel Button Component ---
const PixelButton = ({ type, color, onClick, active }) => {
  const icons = {
    red: [ // Fire
      [0,0,0,1,1,0,0,0],[0,0,1,1,1,1,0,0],[0,1,1,1,1,1,1,0],[1,1,1,0,0,1,1,1],[1,1,0,0,0,0,1,1],[1,1,0,1,1,0,1,1],[0,1,1,1,1,1,1,0],[0,0,1,1,1,1,0,0]
    ],
    green: [ // Bio/Skull
      [0,0,1,1,1,1,0,0],[0,1,1,0,0,1,1,0],[1,1,0,1,1,0,1,1],[1,0,1,1,1,1,0,1],[1,0,1,1,1,1,0,1],[1,1,0,1,1,0,1,1],[0,1,1,0,0,1,1,0],[0,0,1,1,1,1,0,0]
    ],
    blue: [ // Wind/Tornado
      [1,1,1,1,1,0,0,0],[0,0,0,0,1,1,0,0],[0,0,1,1,1,0,0,0],[0,1,1,0,0,0,0,0],[0,0,1,1,1,1,0,0],[0,0,0,0,0,1,1,0],[1,1,0,0,0,1,1,0],[0,1,1,1,1,1,0,0]
    ],
    gold: [ // Lightning
      [0,0,0,0,1,1,0,0],[0,0,0,1,1,0,0,0],[0,0,1,1,0,0,0,0],[0,1,1,1,1,1,1,0],[0,0,0,0,1,1,0,0],[0,0,0,1,1,0,0,0],[0,0,1,1,0,0,0,0],[0,1,1,0,0,0,0,0]
    ]
  };
  const matrix = icons[type] || icons.red;
  return (
    <button 
      onClick={(e) => { e.stopPropagation(); onClick(); }}
      className={`relative w-12 h-12 md:w-14 md:h-14 border-4 transition-all active:translate-y-1 group`}
      style={{
        borderColor: 'white',
        backgroundColor: 'black',
        boxShadow: active ? `0 0 15px ${color}` : `4px 4px 0px 0px rgba(255,255,255,0.3)`
      }}
    >
      <div className="absolute inset-0 flex items-center justify-center">
        <svg viewBox="0 0 8 8" className="w-2/3 h-2/3" style={{ fill: color }}>
          {matrix.map((row, y) => row.map((cell, x) => (cell ? <rect key={`${x}-${y}`} x={x} y={y} width="1" height="1" /> : null)))}
        </svg>
      </div>
    </button>
  );
};

// --- Story Dialog Component ---
const StoryDialog = ({ message, buttonText, onAction, subText }) => {
  const [displayedText, setDisplayedText] = useState('');
  useEffect(() => {
    let index = 0;
    const timer = setInterval(() => {
      if (index < message.length) {
        setDisplayedText(prev => prev + message.charAt(index));
        index++;
      } else {
        clearInterval(timer);
      }
    }, 30);
    return () => clearInterval(timer);
  }, [message]);
  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm px-6">
      <div className="bg-black border-4 border-green-500 p-6 md:p-10 max-w-2xl w-full shadow-[0_0_20px_rgba(34,197,94,0.3)] relative overflow-hidden group">
        <div className="font-retro text-green-400 text-lg md:text-2xl leading-relaxed mb-8 min-h-[80px]">{displayedText}<span className="typing-cursor"></span></div>
        {subText && <div className="text-green-600 font-mono mb-8 text-sm md:text-base border-l-4 border-green-800 pl-4 tracking-wide uppercase">{subText}</div>}
        <button onClick={onAction} className="w-full py-4 bg-green-900/20 border-2 border-green-500 text-green-400 font-bold font-retro text-sm md:text-lg hover:bg-green-500 hover:text-black transition-all uppercase tracking-widest flex items-center justify-center gap-2"><span className="animate-pulse">{'>'}</span> {buttonText}</button>
      </div>
    </div>
  );
};

// --- Badge Icon Component ---
const BadgeIcon = ({ badge, assets }) => {
  const asset = assets[badge.shapeId] || assets.crab;
  const matrix = asset.frame1;
  const color = badge.color;
  const isGolden = color === '#fbbf24';
  const RenderAlien = ({ scale = 1, offsetX = 0, offsetY = 0 }) => (
    <g transform={`translate(${offsetX}, ${offsetY}) scale(${scale})`}>
       {matrix.map((row, r) => row.map((cell, c) => {
          if (!cell) return null;
          let pixelColor = color;
          if (isGolden) { if ((r + c) % 4 === 0) pixelColor = '#fef3c7'; else pixelColor = '#f59e0b'; }
          return <rect key={`${r}-${c}`} x={c} y={r} width="1" height="1" fill={pixelColor} />;
       }))}
    </g>
  );
  return (
    <div className="w-full h-full animate-spin-y" style={{transformStyle: 'preserve-3d'}}>
       <div className={`w-full h-full rounded-full flex items-center justify-center relative overflow-hidden shadow-lg ${isGolden ? 'p-[4px]' : ''}`} style={isGolden ? { background: 'conic-gradient(from 180deg at 50% 50%, #b45309 0deg, #facc15 55deg, #ffffff 120deg, #facc15 160deg, #b45309 260deg, #facc15 300deg, #ffffff 340deg, #b45309 360deg)', boxShadow: '0 0 15px rgba(250, 204, 21, 0.6)' } : { borderColor: color, borderWidth: '4px', borderStyle: 'solid', backgroundColor: 'black' }}>
          <div className={`w-full h-full rounded-full flex items-center justify-center relative bg-black`}>
              <div className="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent pointer-events-none"></div>
              <svg viewBox="0 0 11 8" className="w-2/3 h-2/3" style={{ overflow: 'visible' }}>
                  {badge.iconType === 'single' ? <RenderAlien /> : <><RenderAlien scale={0.6} offsetX={-4} offsetY={2} /><RenderAlien scale={0.6} offsetX={8} offsetY={2} /><RenderAlien scale={0.8} offsetX={2} offsetY={-2} /></>}
              </svg>
          </div>
       </div>
    </div>
  );
};

// --- Settings & Editor Components ---
const SettingsPanel = ({ badges, weapons, onSave, onClose }) => {
    const [localBadges, setLocalBadges] = useState(JSON.parse(JSON.stringify(badges)));
    const [localWeapons, setLocalWeapons] = useState(JSON.parse(JSON.stringify(weapons)));
    const [activeTab, setActiveTab] = useState('badges');
    const handleBadgeChange = (idx, val) => { const newBadges = [...localBadges]; newBadges[idx].score = parseInt(val) || 0; setLocalBadges(newBadges); };
    const handleWeaponChange = (key, field, val) => { setLocalWeapons(prev => ({ ...prev, [key]: { ...prev[key], [field]: parseInt(val) || 0 } })); };
    return (
        <div className="fixed inset-0 z-[160] flex items-center justify-center bg-black/90 backdrop-blur-md select-none text-white font-tech touch-none">
            <div className="bg-gray-900 border-2 border-cyan-500 rounded-lg w-full h-full md:w-[95vw] md:max-w-4xl md:h-[85vh] flex flex-col overflow-hidden">
                <div className="bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center"><h2 className="text-xl flex items-center gap-2 text-cyan-400"><Settings className="w-5 h-5" /> SYSTEM CONFIGURATION</h2><button onClick={onClose}><X className="w-6 h-6" /></button></div>
                <div className="flex border-b border-gray-700">
                    <button onClick={() => setActiveTab('badges')} className={`flex-1 py-3 font-bold ${activeTab === 'badges' ? 'bg-cyan-900/50 text-cyan-300 border-b-2 border-cyan-500' : 'text-gray-400 hover:bg-gray-800'}`}>TROPHY THRESHOLDS</button>
                    <button onClick={() => setActiveTab('weapons')} className={`flex-1 py-3 font-bold ${activeTab === 'weapons' ? 'bg-cyan-900/50 text-cyan-300 border-b-2 border-cyan-500' : 'text-gray-400 hover:bg-gray-800'}`}>WEAPON PARAMETERS</button>
                </div>
                <div className="flex-1 overflow-y-auto p-4 md:p-6 bg-black/50">
                    {activeTab === 'badges' ? (
                        <div className="grid gap-4">{localBadges.map((badge, idx) => (<div key={badge.id} className="flex items-center justify-between bg-gray-800 p-3 rounded border border-gray-700"><div className="flex items-center gap-3"><div className="w-4 h-4 rounded-full" style={{backgroundColor: badge.color}}></div><span className="text-sm font-mono text-gray-300">{badge.name}</span></div><div className="flex items-center gap-2"><span className="text-xs text-gray-500">SCORE:</span><input type="number" value={badge.score} onChange={(e) => handleBadgeChange(idx, e.target.value)} className="w-24 bg-black border border-gray-600 rounded px-2 py-1 text-right text-cyan-400 font-mono focus:border-cyan-500 outline-none" /></div></div>))}</div>
                    ) : (
                        <div className="grid gap-6">{Object.entries(localWeapons).map(([key, weapon]) => (<div key={key} className="bg-gray-800 p-4 rounded border border-gray-700"><div className="flex items-center gap-2 mb-4 border-b border-gray-700 pb-2"><div className="w-3 h-3 rounded-full" style={{backgroundColor: weapon.color}}></div><h3 className="font-bold text-lg text-gray-200 uppercase">{weapon.name} ({key})</h3></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4">{key !== 'default' && (<div className="flex flex-col gap-1"><label className="text-xs text-gray-500">MAX AMMO</label><input type="number" value={weapon.ammo} onChange={(e) => handleWeaponChange(key, 'ammo', e.target.value)} className="bg-black border border-gray-600 rounded px-2 py-1 text-green-400 font-mono" /></div>)}<div className="flex flex-col gap-1"><label className="text-xs text-gray-500">COOLDOWN (ms)</label><input type="number" value={weapon.cooldown} onChange={(e) => handleWeaponChange(key, 'cooldown', e.target.value)} className="bg-black border border-gray-600 rounded px-2 py-1 text-blue-400 font-mono" /></div></div></div>))}</div>
                    )}
                </div>
                <div className="bg-gray-800 p-4 border-t border-gray-700 flex justify-between items-center"><button onClick={() => {}} className="text-xs text-gray-500 hover:text-white flex items-center gap-1"><RefreshCw className="w-3 h-3" /> DEFAULTS</button><div className="flex gap-3"><button onClick={onClose} className="px-4 py-2 text-xs text-gray-400 border border-gray-600 rounded hover:bg-gray-700">CANCEL</button><button onClick={() => onSave(localBadges, localWeapons)} className="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-black font-bold rounded text-xs flex items-center gap-2"><Save className="w-4 h-4" /> APPLY CHANGES</button></div></div>
            </div>
        </div>
    );
};

const PixelEditor = ({ currentAssets, onSave, onClose }) => {
  const [editedAssets, setEditedAssets] = useState(JSON.parse(JSON.stringify(currentAssets)));
  const [selectedAssetId, setSelectedAssetId] = useState(null);
  const [activeFrameTab, setActiveFrameTab] = useState(0); 
  const colors = [{ hex: '#a855f7', name: 'PURPLE' }, { hex: '#ffffff', name: 'WHITE' }, { hex: '#22d3ee', name: 'CYAN' }, { hex: '#facc15', name: 'YELLOW' }, { hex: '#ef4444', name: 'RED' }, { hex: '#22c55e', name: 'GREEN' }];
  const updatePixel = (assetId, frameKey, r, c) => { const asset = editedAssets[assetId]; const newFrame = [...asset[frameKey]]; newFrame[r] = [...newFrame[r]]; newFrame[r][c] = newFrame[r][c] ? 0 : 1; setEditedAssets({ ...editedAssets, [assetId]: { ...asset, [frameKey]: newFrame } }); };
  const updateColor = (assetId, newColor) => { setEditedAssets({ ...editedAssets, [assetId]: { ...editedAssets[assetId], defaultColor: newColor } }); };
  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-md select-none text-white font-tech touch-none-editor">
      <div className="bg-gray-900 border-2 border-green-500 rounded-lg w-full h-full md:w-[95vw] md:max-w-4xl md:h-[85vh] flex flex-col relative overflow-hidden">
        <div className="bg-gray-800 p-3 border-b border-gray-700 flex justify-between items-center shrink-0"><h2 className="text-lg md:text-2xl flex items-center gap-2 text-green-400"><Edit className="w-5 h-5" /> EDITOR</h2><button onClick={onClose}><X className="w-6 h-6" /></button></div>
        <div className="flex-1 flex flex-col md:flex-row overflow-hidden">
            <div className="w-full md:w-1/4 bg-gray-900 border-b md:border-b-0 md:border-r border-gray-700 p-2 overflow-x-auto md:overflow-y-auto flex md:flex-col gap-2 shrink-0">{Object.values(editedAssets).map(asset => (<div key={asset.id} onClick={() => setSelectedAssetId(asset.id)} className={`min-w-[80px] md:min-w-0 p-2 rounded border-2 cursor-pointer ${selectedAssetId === asset.id ? 'border-green-500 bg-gray-800' : 'border-gray-700'}`}><div className="flex justify-between items-center mb-1"><div className="w-2 h-2 rounded-full" style={{backgroundColor: asset.defaultColor}}></div><span className="text-[10px] font-bold text-gray-300 md:text-xs truncate">{asset.name}</span></div><div className="w-full aspect-[11/8] bg-black p-0.5"><svg viewBox="0 0 11 8" className="w-full h-full" style={{color: asset.defaultColor}}>{asset.frame1.map((row, r) => row.map((cell, c) => (cell ? <rect key={`pre-${r}-${c}`} x={c} y={r} width="1" height="1" fill="currentColor" /> : null)))}</svg></div></div>))}</div>
            <div className="flex-1 p-2 md:p-6 flex flex-col bg-black/50 overflow-y-auto">{selectedAssetId ? (<><div className="flex flex-col md:flex-row justify-between items-center mb-2 md:mb-4 gap-2"><div className="flex flex-col items-center md:items-start"><h3 className="text-sm md:text-xl text-green-300 mb-1">{editedAssets[selectedAssetId].name}</h3><div className="flex gap-2">{colors.map(c => (<button key={c.hex} onClick={() => updateColor(selectedAssetId, c.hex)} className={`w-6 h-6 md:w-8 md:h-8 rounded border ${editedAssets[selectedAssetId].defaultColor === c.hex ? 'border-white scale-110' : 'border-transparent opacity-50'}`} style={{backgroundColor: c.hex}} />))}</div></div></div><div className="flex-1 flex flex-col md:flex-row gap-4 md:gap-8 justify-center items-center h-full"><div className={`flex-col items-center gap-2 ${activeFrameTab === 0 ? 'flex' : 'hidden md:flex'}`}><div className="bg-gray-800 p-1 md:p-2 border border-gray-600 rounded"><div className="grid grid-cols-11 gap-px bg-gray-900 border border-gray-700 w-[70vw] max-w-[300px] md:w-[30vh] aspect-[11/8]">{editedAssets[selectedAssetId].frame1.map((row, r) => row.map((cell, c) => (<div key={`f1-${r}-${c}`} onPointerDown={() => updatePixel(selectedAssetId, 'frame1', r, c)} className="w-full h-full cursor-pointer" style={{backgroundColor: cell ? editedAssets[selectedAssetId].defaultColor : 'transparent'}} />)))}</div></div></div></div></>) : <div className="flex-1 flex flex-col items-center justify-center text-gray-600"><MousePointer2 className="w-12 h-12 mb-4 opacity-50" /><p className="text-xs">SELECT ENTITY</p></div>}</div>
        </div>
        <div className="bg-gray-800 p-3 border-t border-gray-700 flex justify-between items-center shrink-0"><div className="flex gap-2"><button onClick={onClose} className="px-4 py-2 text-xs text-gray-400 border border-gray-600 rounded">CANCEL</button><button onClick={() => onSave(editedAssets)} className="flex items-center gap-2 px-6 py-2 bg-green-600 text-black font-bold rounded text-xs"><Save className="w-3 h-3" /> SAVE</button></div></div>
      </div>
    </div>
  );
};

// --- 3D Scene ---
const ThreeScene = ({ active, triggerExplosion, assets }) => {
  const mountRef = useRef(null);
  const particlesRef = useRef(null);
  const requestRef = useRef(null);
  const matrix = assets.crab.frame1;
  const color = assets.crab.defaultColor;

  useEffect(() => {
    if (!mountRef.current) return;
    const scene = new THREE.Scene();
    const isMobile = window.innerWidth < 768;
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = isMobile ? 30 : 15;
    const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    mountRef.current.appendChild(renderer.domElement);
    const particleGroup = new THREE.Group();
    scene.add(particleGroup);
    particlesRef.current = particleGroup;
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);
    const pointLight = new THREE.PointLight(0xffffff, 1);
    pointLight.position.set(10, 10, 10);
    scene.add(pointLight);
    const animate = (time) => {
      requestRef.current = requestAnimationFrame(animate);
      if (particlesRef.current) {
        if (!particlesRef.current.children[0]?.userData.isExploding) {
          particlesRef.current.rotation.y = Math.sin(time * 0.0005) * 0.2;
          particlesRef.current.rotation.x = Math.sin(time * 0.001) * 0.1;
        }
        particlesRef.current.children.forEach(p => {
          if (p.userData.isExploding) {
            p.position.add(p.userData.velocity);
            p.rotation.x += 0.05;
            p.children.forEach(mesh => { if (mesh.material.opacity > 0) mesh.material.opacity -= 0.02; });
          } else {
            p.position.y = p.userData.originalPos.y + Math.sin(time * 0.002 + p.position.x) * 0.1;
            const scale = 1 + Math.sin(time * 0.003 + p.userData.phaseOffset) * 0.1;
            p.scale.set(scale, scale, scale);
          }
        });
      }
      renderer.render(scene, camera);
    };
    animate();
    const handleResize = () => { 
        camera.aspect = window.innerWidth / window.innerHeight; 
        camera.updateProjectionMatrix(); 
        renderer.setSize(window.innerWidth, window.innerHeight); 
        camera.position.z = window.innerWidth < 768 ? 30 : 15;
    };
    window.addEventListener('resize', handleResize);
    return () => { window.removeEventListener('resize', handleResize); cancelAnimationFrame(requestRef.current); if (mountRef.current) mountRef.current.removeChild(renderer.domElement); };
  }, []);

  useEffect(() => {
    if (!particlesRef.current || !matrix) return;
    while(particlesRef.current.children.length > 0) particlesRef.current.remove(particlesRef.current.children[0]);
    const geometry = new THREE.CylinderGeometry(0.5, 0.5, 0.2, 6); 
    geometry.rotateX(Math.PI / 2);
    const threeColor = new THREE.Color(color);
    const wireframeMaterial = new THREE.MeshBasicMaterial({ color: threeColor.clone().offsetHSL(0, 0, 0.2), wireframe: true, transparent: true, opacity: 0.6 }); 
    const coreMaterial = new THREE.MeshBasicMaterial({ color: threeColor, transparent: true, opacity: 0.8 });
    const offsetX = -5.5; const offsetY = 4;
    matrix.forEach((row, y) => { row.forEach((val, x) => { if (val === 1) { const pixelGroup = new THREE.Group(); const core = new THREE.Mesh(geometry, coreMaterial); const wireframe = new THREE.Mesh(geometry, wireframeMaterial); wireframe.scale.set(1.1, 1.1, 1.1); pixelGroup.add(core); pixelGroup.add(wireframe); pixelGroup.position.set(x + offsetX, -(y - offsetY), 0); pixelGroup.rotation.z = Math.random() * 0.2; pixelGroup.userData = { originalPos: new THREE.Vector3(x + offsetX, -(y - offsetY), 0), velocity: new THREE.Vector3(0, 0, 0), isExploding: false, phaseOffset: Math.random() * Math.PI * 2 }; particlesRef.current.add(pixelGroup); } }); });
  }, [matrix, color]);

  useEffect(() => {
    if (triggerExplosion && particlesRef.current) {
      particlesRef.current.children.forEach(p => { p.userData.isExploding = true; p.userData.velocity.set((Math.random() - 0.5) * 1.5, (Math.random() - 0.5) * 1.5, (Math.random() - 0.5) * 8 + 3); p.children.forEach(mesh => { mesh.material = new THREE.MeshBasicMaterial({ color: 0xff3333, wireframe: mesh.material.wireframe }); }); });
    }
  }, [triggerExplosion]);

  return <div ref={mountRef} className="absolute inset-0 w-full h-full" style={{ opacity: active ? 1 : 0, transition: 'opacity 1s ease' }} />;
};

// --- MAIN APP ---
export default function ProjectEVO() {
  const [scrollProgress, setScrollProgress] = useState(0);
  
  // NARRATIVE STATE
  const [heroStage, setHeroStage] = useState(0); 
  const [dialogConfig, setDialogConfig] = useState(null);
  const [showLevelUpToast, setShowLevelUpToast] = useState(false);
  const [isGameOver, setIsGameOver] = useState(false);
  const [gameStarted, setGameStarted] = useState(false);
  const [isLevelClear, setIsLevelClear] = useState(false); 

  const [aiTriggered, setAiTriggered] = useState(false);
  const [retroScore, setRetroScore] = useState(0);
  const [isPaused, setIsPaused] = useState(false); 
  
  // States
  const [gameAssets, setGameAssets] = useState(DEFAULT_ASSETS);
  const [isEditorOpen, setIsEditorOpen] = useState(false);
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  
  // Config States
  const [badgeConfigs, setBadgeConfigs] = useState(DEFAULT_BADGES);
  const [weaponConfigs, setWeaponConfigs] = useState(DEFAULT_WEAPONS);

  const [badgesUnlocked, setBadgesUnlocked] = useState([]);
  const [showBadgeList, setShowBadgeList] = useState(false);
  const [newBadge, setNewBadge] = useState(null); 
  
  // Power Ups
  const [weaponType, setWeaponType] = useState('default');
  const [ammo, setAmmo] = useState(Infinity);
  const [redShotsFired, setRedShotsFired] = useState(0);
  const [isRedOverheated, setIsRedOverheated] = useState(false);
  const lastShotTimeRef = useRef(0);
  
  // Stats tracking for story progression
  const totalShotsRef = useRef(0);

  // Game Entities Refs
  const canvasRef = useRef(null);
  const shipPos = useRef(50); 
  const bullets = useRef([]);
  const enemies = useRef([]);
  const gems = useRef([]); 
  const effects = useRef([]); 
  const gameLoopRef = useRef(null);
  const notificationTimeoutRef = useRef(null);
  const animationFrameRef = useRef(0);
  const lastAnimationTime = useRef(0);
  
  // Alien Descent Logic
  const alienDropCountRef = useRef(0);

  const POWERUP_PROBABILITY = [
    { type: 'red', count: 2 },
    { type: 'green', count: 2 },
    { type: 'blue', count: 2 },
    { type: 'gold', count: 1 }
  ];

  // --- Scroll Logic ---
  useEffect(() => {
    const handleScroll = () => {
      const totalScroll = document.documentElement.scrollTop;
      const windowHeight = window.innerHeight;
      const totalHeight = document.body.scrollHeight - windowHeight;
      const progress = Math.min(Math.max(totalScroll / totalHeight, 0), 1);
      setScrollProgress(progress);
    };
    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  // --- Alien Descent Timer ---
  useEffect(() => {
    const timer = setInterval(() => {
      if (gameStarted && !isPaused && !isGameOver && heroStage < 3 && !isLevelClear) {
        alienDropCountRef.current += 1;
      }
    }, 1000);
    return () => clearInterval(timer);
  }, [gameStarted, isPaused, isGameOver, heroStage, isLevelClear]);

  // --- Story Progression Logic ---
  useEffect(() => {
    // Stage 0 -> 1
    if (heroStage === 0 && retroScore >= 1000 && !dialogConfig) {
        setIsPaused(true);
        setDialogConfig({
            message: "FEELING DULL?",
            subText: "MONOTONOUS VISUALS CAN'T HOLD ATTENTION.",
            btnText: "UPGRADE MY BRAND",
            action: () => {
                setHeroStage(1);
                setRetroScore(0);
                setDialogConfig(null);
                setIsPaused(false);
                setShowLevelUpToast(true);
                setTimeout(() => setShowLevelUpToast(false), 5500);
                setGameStarted(false);
                alienDropCountRef.current = 0;
                initGame();
            }
        });
    }

    // Stage 1 -> 2
    if (heroStage === 1 && retroScore > 8000 && !dialogConfig) {
        setIsPaused(true);
        setDialogConfig({
            message: "READY FOR THE NEXT DIMENSION?",
            subText: "AI & 3D EXPERIENCES ARE THE FUTURE.",
            btnText: "ACTIVATE FUTURE ENGINE",
            action: () => {
                setHeroStage(3);
                setDialogConfig(null);
                setIsPaused(false);
            }
        });
    }
  }, [heroStage, retroScore, isPaused]);

  // --- Init Game ---
  const initGame = () => {
      bullets.current = [];
      enemies.current = [];
      gems.current = [];
      effects.current = [];
      setRetroScore(0);
      setWeaponType('default');
      setAmmo(Infinity);
      totalShotsRef.current = 0;
      alienDropCountRef.current = 0;
      setGameStarted(false);
      setIsGameOver(false);
      setIsLevelClear(false);
      
      const rows = [
          { y: 15, id: 'crab' }, { y: 19, id: 'crab', overrideColor: '#ffffff' }, 
          { y: 23, id: 'squid' }, { y: 27, id: 'octopus' }, 
          { y: 31, id: 'ufo' }, { y: 35, id: 'green_alien' }
      ];

      const shapes = ['circle', 'square', 'triangle'];

      rows.forEach(row => {
          const assetData = gameAssets[row.id];
          for(let i=0; i<5; i++) {
              const shapeType = shapes[Math.floor(Math.random() * shapes.length)];
              enemies.current.push({ 
                  x: 10 + i * 20, 
                  originalY: row.y, 
                  y: row.y, 
                  alive: true, 
                  color: row.overrideColor || assetData.defaultColor, 
                  assetId: row.id,
                  shapeType: shapeType
              });
          }
      });
  };

  useEffect(() => { initGame(); }, [gameAssets]);

  // --- Helpers ---
  const activatePowerUp = (type) => { const weapon = weaponConfigs[type]; setWeaponType(type); setAmmo(weapon.ammo); setRedShotsFired(0); setIsRedOverheated(false); };
  
  const spawnEffect = (x, y, type) => {
      let duration = 0;
      let spriteKey = null;

      if (type === 'fire') { duration = 400; spriteKey = 'red'; }
      else if (type === 'smoke') { duration = 400; spriteKey = 'green'; }
      else if (type === 'vortex') { duration = 400; spriteKey = 'blue'; }
      else if (type === 'gold') { duration = 400; spriteKey = 'gold'; }
      else { duration = 200; spriteKey = null; }

      if(heroStage > 0) {
          effects.current.push({ x, y, type, spriteKey, createdAt: Date.now(), duration });
      } else {
          effects.current.push({ x, y, type: 'simple', createdAt: Date.now(), duration: 200 }); 
      }
      
      // Strict Neighbor Kill for Green Virus
      if (type === 'smoke' && heroStage > 0) {
          enemies.current.forEach(e => {
             // x is percentage (spaced by 20), y is percentage (rows spaced by 4)
             // Check X <= 22 (hits +/- 20 neighbors) AND Y <= 2.5 (hits only same row)
             if (e.alive && Math.abs(e.x - x) <= 22 && Math.abs(e.y - y) <= 2.5) {
                 e.alive = false;
                 setRetroScore(s => s + 200);
             }
          });
      }
  };

  // --- Score Monitor ---
  useEffect(() => {
      if (retroScore === 0 || heroStage < 1) return;
      const earnedBadges = badgeConfigs.filter(b => b.score <= retroScore && !badgesUnlocked.includes(b.id)); 
      if (earnedBadges.length > 0) {
          const badge = earnedBadges[earnedBadges.length - 1];
          setBadgesUnlocked(prev => [...prev, badge.id]);
          setIsPaused(true);
          setNewBadge(badge);
          if (notificationTimeoutRef.current) clearTimeout(notificationTimeoutRef.current);
          notificationTimeoutRef.current = setTimeout(() => { handleCloseNotification(); }, 3000);
      }
  }, [retroScore, badgesUnlocked, badgeConfigs, heroStage]);

  const handleCloseNotification = () => { setNewBadge(null); if (!isEditorOpen && !showBadgeList && !isSettingsOpen && !dialogConfig && !isGameOver) setIsPaused(false); };

  // --- Game Loop ---
  useEffect(() => {
    if (heroStage === 3) return; 

    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    
    const handleResize = () => {
        if(canvas && canvas.parentElement) {
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = canvas.parentElement.offsetHeight;
        }
    };
    handleResize();
    window.addEventListener('resize', handleResize);

    const updateGame = (timestamp) => {
      const now = Date.now();

      if (isPaused || isGameOver || isLevelClear) { 
          if(isGameOver) {
             ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
             ctx.fillRect(0, 0, canvas.width, canvas.height);
          }
          if(isLevelClear) {
              ctx.fillStyle = '#000000'; 
              ctx.fillRect(0, 0, canvas.width, canvas.height);
          }
          gameLoopRef.current = requestAnimationFrame(updateGame); 
          return; 
      }

      if (timestamp - lastAnimationTime.current > 400) { animationFrameRef.current = animationFrameRef.current === 0 ? 1 : 0; lastAnimationTime.current = timestamp; }
      const frameIndex = animationFrameRef.current;
      
      if (isRedOverheated && now > lastShotTimeRef.current + weaponConfigs.red.heatCoolTime) { 
          setIsRedOverheated(false); 
          setRedShotsFired(0); 
      }

      ctx.fillStyle = '#000000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      if (heroStage > 0) {
        ctx.strokeStyle = '#113311'; ctx.lineWidth = 2;
        ctx.beginPath(); for(let i=0; i<canvas.width; i+=40) { ctx.moveTo(i,0); ctx.lineTo(i, canvas.height); } for(let i=0; i<canvas.height; i+=40) { ctx.moveTo(0,i); ctx.lineTo(canvas.width, i); } ctx.stroke();
      }

      const shipPxY = canvas.height - 100;
      const shipPxX = (shipPos.current / 100) * canvas.width;

      // Alien Descent
      const startYPixels = (15 / 100) * canvas.height;
      const lowestAlienStartPixels = (35/100) * canvas.height; 
      const safeDistance = shipPxY - lowestAlienStartPixels;
      const stepSizePixels = safeDistance / 50; 

      // Effects
      effects.current = effects.current.filter(e => now - e.createdAt < e.duration);
      effects.current.forEach(eff => {
          const ex = (eff.x / 100) * canvas.width;
          const ey = (eff.y / 100) * canvas.height;
          const lifePct = (now - eff.createdAt) / eff.duration;
          
          if (eff.type === 'simple' || !eff.spriteKey) {
             ctx.fillStyle = `rgba(255, 255, 255, ${1 - lifePct})`;
             ctx.fillRect(ex - 10, ey - 10, 20, 20);
          } else {
             const spriteData = IMPACT_SPRITES[eff.spriteKey];
             if (!spriteData) {
                 ctx.fillStyle = `rgba(255, 215, 0, ${1 - lifePct})`; 
                 ctx.fillRect(ex - 10, ey - 10, 20, 20);
                 return;
             }
             const frameIdx = lifePct < 0.5 ? 0 : 1; 
             const matrix = spriteData.frames[frameIdx];
             const colorMap = spriteData.colors;
             
             if (matrix) {
                 const pixelSize = 2; 
                 const width = matrix[0].length * pixelSize;
                 const height = matrix.length * pixelSize;
                 
                 matrix.forEach((row, r) => {
                     row.forEach((colVal, c) => {
                         const hex = colorMap && colorMap[colVal] ? colorMap[colVal] : colVal;
                         if (hex && hex !== 0 && hex !== "#000000") {
                             const drawX = ex - (width / 2) + c * pixelSize;
                             const drawY = ey - (height / 2) + r * pixelSize;
                             ctx.fillStyle = hex;
                             ctx.fillRect(drawX, drawY, pixelSize, pixelSize);
                         }
                     });
                 });
             }
          }
      });

      bullets.current.forEach(b => {
         let speed = (b.type === 'red' ? 8 : 5);
         if (b.type === 'gold') {
             if (b.y < canvas.height / 2) { speed = 20; b.accelerated = true; } else { speed = 8; }
         }
         b.y -= speed;
      });
      
      // Cleanup used bullets at end of frame
      bullets.current = bullets.current.filter(b => !b.used && b.y > 0);

      // Check Victory
      if (gameStarted && enemies.current.length > 0 && enemies.current.every(e => !e.alive)) {
          setIsLevelClear(true);
      }

      enemies.current.forEach(e => {
        if (!e.alive) return;
        
        const dropYPercent = (alienDropCountRef.current * stepSizePixels) / canvas.height * 100;
        const currentYPercent = e.originalY + dropYPercent;
        
        const ex = (e.x / 100) * canvas.width;
        let ey = (currentYPercent / 100) * canvas.height;
        e.y = currentYPercent; // Update ref for effects

        // Game Over
        if (Math.abs(ey - shipPxY) < 30 && Math.abs(ex - shipPxX) < 40) {
             setIsGameOver(true);
        }

        // Render Enemy
        if (heroStage === 0) {
            ctx.fillStyle = '#aaaaaa'; 
            ctx.strokeStyle = '#888888';
            ctx.lineWidth = 2;
            const size = 20;
            if (e.shapeType === 'circle') { ctx.beginPath(); ctx.arc(ex, ey, size/2, 0, Math.PI*2); ctx.fill(); ctx.stroke(); } 
            else if (e.shapeType === 'square') { ctx.fillRect(ex - size/2, ey - size/2, size, size); ctx.strokeRect(ex - size/2, ey - size/2, size, size); } 
            else { ctx.beginPath(); ctx.moveTo(ex, ey - size/2); ctx.lineTo(ex + size/2, ey + size/2); ctx.lineTo(ex - size/2, ey + size/2); ctx.closePath(); ctx.fill(); ctx.stroke(); }
        } else {
            ctx.fillStyle = e.color; 
            const asset = gameAssets[e.assetId];
            const shapeMatrix = frameIndex === 0 ? asset.frame1 : asset.frame2;
            shapeMatrix.forEach((row, r) => { row.forEach((cell, c) => { if(cell) { const drawX = ex - (11*3/2) + c * 3; const drawY = ey + r * 3; ctx.fillRect(drawX, drawY, 3, 3); } }); });
        }

        // Bullet Collision
        bullets.current.forEach((b, bIdx) => {
            if (b.used) return; 
            const bx = b.x; const by = b.y;
            if (Math.abs(bx - ex) < 20 && Math.abs(by - ey) < 20) {
                e.alive = false; 
                setRetroScore(s => s + 200); 
                if (!gameStarted) setGameStarted(true);

                // EFFECTS
                if (heroStage > 0) {
                    if (b.type === 'red') spawnEffect(e.x, currentYPercent, 'fire');
                    if (b.type === 'green') spawnEffect(e.x, currentYPercent, 'smoke'); // Triggers strict neighbor kill
                    if (b.type === 'blue') spawnEffect(e.x, currentYPercent, 'vortex');
                    if (b.type === 'gold') spawnEffect(e.x, currentYPercent, 'gold'); 
                    if (b.type === 'default') spawnEffect(e.x, currentYPercent, 'simple');
                } else {
                    spawnEffect(e.x, currentYPercent, 'simple'); 
                }
                
                if (b.type !== 'gold') { b.used = true; } 
            }
        });
      });

      // --- SHIP RENDERING ---
      if (heroStage === 0) {
          ctx.fillStyle = weaponConfigs[weaponType].color; 
          ctx.fillRect(shipPxX - 15, shipPxY + 10, 30, 10); 
          ctx.fillRect(shipPxX - 5, shipPxY, 10, 10);
      } else {
          const pixelSize = 3;
          const shipWidth = PLAYER_SHIP_DEF[0].length * pixelSize;
          PLAYER_SHIP_DEF.forEach((row, r) => {
              row.forEach((color, c) => {
                  if (color !== "#000000") {
                      let fill = color;
                      if (color === '#FF0000' && r < 16) { fill = weaponConfigs[weaponType].color; }
                      const drawX = shipPxX - (shipWidth / 2) + c * pixelSize;
                      const drawY = shipPxY + r * pixelSize;
                      ctx.fillStyle = fill;
                      ctx.fillRect(drawX, drawY, pixelSize, pixelSize);
                  }
              });
          });
      }

      // --- BULLET RENDERING ---
      bullets.current.forEach(b => {
         if (b.used) return; 

         if (heroStage === 0 || b.type === 'default' || !BULLET_SPRITES[b.type]) {
             ctx.fillStyle = weaponConfigs[b.type || 'default'].color;
             if (b.type === 'gold' && b.accelerated) {
                 for(let i=1; i<=4; i++) {
                     ctx.fillStyle = `rgba(251, 191, 36, ${1 - i*0.2})`; 
                     ctx.fillRect(b.x - 2, b.y + i*6, 4, 10);
                 }
                 ctx.fillStyle = '#ffffff'; 
             }
             ctx.fillRect(b.x - 2, b.y, 4, 10); 
         } else {
             const spriteData = BULLET_SPRITES[b.type];
             const matrix = spriteData.frames[frameIndex] || spriteData.frames[0];
             const pixelSize = 2; 
             const width = matrix[0].length * pixelSize;
             
             matrix.forEach((row, r) => {
                 row.forEach((color, c) => {
                     let fill = color;
                     if(spriteData.colors && spriteData.colors[color]) fill = spriteData.colors[color];
                     
                     if (fill !== 0 && fill !== "#000000") {
                         const drawX = b.x - (width / 2) + c * pixelSize;
                         const drawY = b.y + r * pixelSize;
                         ctx.fillStyle = fill;
                         ctx.fillRect(drawX, drawY, pixelSize, pixelSize);
                     }
                 });
             });
         }
      });

      gameLoopRef.current = requestAnimationFrame(updateGame);
    };

    gameLoopRef.current = requestAnimationFrame(updateGame);
    return () => { 
        window.removeEventListener('resize', handleResize);
        cancelAnimationFrame(gameLoopRef.current); 
    };
  }, [heroStage, gameAssets, isPaused, weaponType, weaponConfigs, isGameOver, gameStarted, isLevelClear]); 

  // Touch Logic
  const handleGameInteraction = (e) => {
      if (heroStage > 2 || !canvasRef.current || isPaused || isGameOver || isLevelClear) return;
      const now = Date.now();
      const wData = weaponConfigs[weaponType];
      if (weaponType === 'red' && isRedOverheated) return;
      if (now - lastShotTimeRef.current < wData.cooldown) return;
      const canvas = canvasRef.current;
      const rect = canvas.getBoundingClientRect();
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      if (!clientX) return;
      const clickX = clientX - rect.left;
      const percentage = (clickX / rect.width) * 100;
      shipPos.current = Math.min(Math.max(percentage, 5), 95);
      
      const shipPxY = canvas.height - 100; 

      bullets.current.push({ 
          x: (shipPos.current / 100) * canvas.width, 
          y: shipPxY, 
          used: false,
          type: weaponType 
      });
      lastShotTimeRef.current = now;
      totalShotsRef.current += 1; 

      if (weaponType !== 'default') {
          setAmmo(a => { const newAmmo = a - 1; if (newAmmo <= 0) { setWeaponType('default'); setAmmo(Infinity); } return newAmmo; });
          if (weaponType === 'red') { const newShots = redShotsFired + 1; setRedShotsFired(newShots); if (newShots >= wData.maxShotsBeforeHeat) setIsRedOverheated(true); }
      }
  };

  const handleOpenEditor = () => { setIsPaused(true); setIsEditorOpen(true); };
  const handleOpenBadgeList = () => { setIsPaused(true); setShowBadgeList(true); };
  const handleOpenSettings = () => { setIsPaused(true); setIsSettingsOpen(true); };
  const handleCloseBadgeList = () => { setShowBadgeList(false); setIsPaused(false); };
  const handleEditorSave = (newAssets) => { setGameAssets(newAssets); setIsEditorOpen(false); setIsPaused(false); };
  const handleEditorClose = () => { setIsEditorOpen(false); setIsPaused(false); };
  const handleSettingsSave = (newBadges, newWeapons) => { setBadgeConfigs(newBadges); setWeaponConfigs(newWeapons); setIsSettingsOpen(false); setIsPaused(false); };
  const handleSettingsClose = () => { setIsSettingsOpen(false); setIsPaused(false); };
  const handleAiExecute = () => { setAiTriggered(true); };
  const handleRestart = () => { setRetroScore(0); initGame(); };
  const handleNextLevel = () => { 
      initGame(); 
  };

  return (
    <div className="bg-black min-h-[100vh] text-white relative select-none font-sans">
      <FontStyles />

      {/* --- VICTORY OVERLAY --- */}
      {isLevelClear && (
          <div className="fixed inset-0 z-[250] flex items-center justify-center bg-black/80 backdrop-blur-md">
              <div className="text-center flex flex-col items-center">
                  <div className="w-48 h-48 mb-6 relative">
                     <div className="absolute inset-0 bg-yellow-500 blur-3xl opacity-20 animate-pulse"></div>
                     <svg viewBox="0 0 12 11" className="w-full h-full drop-shadow-[0_0_15px_rgba(234,179,8,0.8)]">
                        {VICTORY_SPRITE.map((row, y) => row.map((cell, x) => (
                           cell ? <rect key={`${x}-${y}`} x={x} y={y} width="1" height="1" fill="#facc15" /> : null
                        )))}
                     </svg>
                  </div>
                  <h1 className="text-5xl md:text-8xl font-retro text-yellow-400 mb-4 tracking-widest drop-shadow-[4px_4px_0_rgba(255,255,255,0.2)] animate-blink">STAGE CLEAR</h1>
                  <p className="text-white font-mono mb-8">ALL THREATS NEUTRALIZED</p>
                  <button onClick={handleNextLevel} className="px-8 py-4 bg-white text-black font-retro text-xl hover:bg-yellow-400 hover:text-black transition-colors border-4 border-transparent hover:border-white uppercase tracking-widest cursor-pointer">
                      NEXT MISSION
                  </button>
              </div>
          </div>
      )}

      {/* --- GAME OVER MODAL --- */}
      {isGameOver && (
          <div className="fixed inset-0 z-[250] flex items-center justify-center bg-black/80 backdrop-blur-md">
              <div className="text-center animate-bounce">
                  <h1 className="text-5xl md:text-8xl font-retro text-red-500 mb-4 tracking-widest drop-shadow-[4px_4px_0_rgba(255,255,255,0.2)]">GAME OVER</h1>
                  <p className="text-white font-mono mb-8">SYSTEM CRITICAL FAILURE</p>
                  <button onClick={handleRestart} className="px-8 py-4 bg-white text-black font-retro text-xl hover:bg-red-500 hover:text-white transition-colors border-4 border-transparent hover:border-white uppercase tracking-widest cursor-pointer">
                      RETRY MISSION
                  </button>
              </div>
          </div>
      )}

      {/* --- LEVEL UP TOAST OVERLAY (RETRO STYLE & METRICS) --- */}
      {showLevelUpToast && (
          <div className="fixed inset-0 z-[250] flex items-center justify-center pointer-events-none" style={{animation: 'fadeOut 5.5s forwards'}}>
              <div className="bg-black p-6 md:p-10 border-4 border-white shadow-[10px_10px_0px_0px_rgba(255,255,255,0.5)] max-w-2xl w-full mx-4">
                  <h1 className="text-4xl md:text-7xl font-retro text-green-400 mb-6 animate-blink text-center">
                      LEVEL UP!!
                  </h1>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-8 font-mono text-white text-left">
                    {/* List Section */}
                    <div className="space-y-4">
                        <h3 className="text-cyan-400 border-b border-cyan-400 pb-2 mb-2 font-tech font-bold text-lg">SYSTEM UPGRADES:</h3>
                        <ul className="space-y-3 text-sm md:text-base">
                            <li className="flex items-center gap-3">
                                <span className="text-green-500 font-bold"></span> 
                                <span className="flex-1">CHARACTER STYLES</span>
                                <span className="text-green-400 text-[10px] border border-green-400 px-1 rounded">MAX</span>
                            </li>
                            <li className="flex items-center gap-3">
                                <span className="text-green-500 font-bold"></span> 
                                <span className="flex-1">SHOOTING ABILITY</span>
                                <span className="text-yellow-400 text-[10px] border border-yellow-400 px-1 rounded">NEW</span>
                            </li>
                            <li className="flex items-center gap-3">
                                <span className="text-green-500 font-bold"></span> 
                                <span className="flex-1">REWARD SYSTEM</span>
                                <span className="text-cyan-400 text-[10px] border border-cyan-400 px-1 rounded">ONLINE</span>
                            </li>
                        </ul>
                    </div>

                    {/* Comparison Table Section */}
                    <div>
                        <h3 className="text-cyan-400 border-b border-cyan-400 pb-2 mb-2 font-tech font-bold text-lg">PERFORMANCE METRICS:</h3>
                        <div className="space-y-4 font-retro text-xs md:text-sm">
                            <div className="flex flex-col gap-1">
                                <div className="flex justify-between items-end mb-1">
                                    <span className="text-gray-400">FUN</span>
                                    <span className="text-green-400">+70%</span>
                                </div>
                                <div className="h-2 bg-gray-800 relative w-full overflow-hidden">
                                    <div className="absolute top-0 left-0 h-full bg-green-500 animate-[shine_2s_infinite]" style={{width: '70%'}}></div>
                                </div>
                            </div>
                            <div className="flex flex-col gap-1">
                                <div className="flex justify-between items-end mb-1">
                                    <span className="text-gray-400">VISUALS</span>
                                    <span className="text-green-400">+80%</span>
                                </div>
                                <div className="h-2 bg-gray-800 relative w-full overflow-hidden">
                                    <div className="absolute top-0 left-0 h-full bg-purple-500 animate-[shine_2s_infinite]" style={{width: '80%'}}></div>
                                </div>
                            </div>
                            <div className="flex flex-col gap-1">
                                <div className="flex justify-between items-end mb-1">
                                    <span className="text-gray-400">CONTROL</span>
                                    <span className="text-green-400">+80%</span>
                                </div>
                                <div className="h-2 bg-gray-800 relative w-full overflow-hidden">
                                    <div className="absolute top-0 left-0 h-full bg-cyan-500 animate-[shine_2s_infinite]" style={{width: '80%'}}></div>
                                </div>
                            </div>
                        </div>
                    </div>
                  </div>
              </div>
          </div>
      )}

      {/* --- NARRATIVE DIALOG MODAL --- */}
      {dialogConfig && (
        <StoryDialog 
            message={dialogConfig.message} 
            subText={dialogConfig.subText}
            buttonText={dialogConfig.btnText} 
            onAction={dialogConfig.action} 
        />
      )}

      {/* --- NOTIFICATION MODAL --- */}
      {newBadge && (
        <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/60 backdrop-blur-md px-4">
            <div className="bg-gradient-to-b from-gray-900 to-black border-2 border-yellow-500 p-6 md:p-8 rounded-xl shadow-[0_0_100px_rgba(234,179,8,0.5)] flex flex-col items-center max-w-sm w-full text-center badge-shine">
                <h2 className="text-2xl md:text-3xl font-tech text-yellow-400 mb-4 md:mb-6 tracking-widest drop-shadow-md">CONGRATULATIONS</h2>
                <div className="w-24 h-24 md:w-32 md:h-32 mb-4 md:mb-6"><BadgeIcon badge={newBadge} assets={gameAssets} /></div>
                <p className="text-gray-400 font-mono text-xs mb-2">ACHIEVEMENT UNLOCKED</p>
                <h3 className="text-lg md:text-xl font-bold text-white mb-6 md:mb-8 font-retro leading-relaxed">YOU ARE<br/><span style={{color: newBadge.color}}>{newBadge.name}</span></h3>
                <button onClick={handleCloseNotification} className="px-6 py-2 md:px-8 md:py-3 bg-yellow-600 hover:bg-yellow-500 text-black font-bold font-tech rounded uppercase tracking-widest transition-transform transform hover:scale-105">Continue</button>
            </div>
        </div>
      )}

      {/* --- BADGE LIST MODAL --- */}
      {showBadgeList && (
        <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/80 backdrop-blur-sm">
            <div className="bg-gray-900 border-2 border-yellow-600 rounded-lg p-4 md:p-6 w-full h-full md:w-[95vw] md:max-w-3xl md:h-auto md:relative shadow-2xl overflow-y-auto">
                <button onClick={handleCloseBadgeList} className="absolute top-4 right-4 text-gray-500 hover:text-white"><X className="w-8 h-8" /></button>
                <h2 className="text-xl md:text-2xl font-tech text-yellow-500 mb-6 flex items-center gap-3 mt-8 md:mt-0"><Trophy className="w-6 h-6" /> HALL OF FAME</h2>
                <div className="grid grid-cols-3 md:grid-cols-5 gap-4 pb-10">
                    {Array.from({ length: 15 }).map((_, idx) => {
                        const badge = badgeConfigs[idx];
                        const isUnlocked = badge && badgesUnlocked.includes(badge.id);
                        return (
                            <div key={idx} className="flex flex-col items-center gap-2">
                                <div className={`w-16 h-16 md:w-20 md:h-20 rounded-full flex items-center justify-center border-4 relative transition-all duration-500 ${isUnlocked ? 'border-gray-700 bg-gray-800' : 'border-gray-800 bg-black'}`} style={isUnlocked ? (badge.color === '#fbbf24' ? { background: 'conic-gradient(from 180deg at 50% 50%, #b45309 0deg, #facc15 55deg, #ffffff 120deg, #facc15 160deg, #b45309 260deg, #facc15 300deg, #ffffff 340deg, #b45309 360deg)', boxShadow: '0 0 15px rgba(250, 204, 21, 0.6)', padding: '4px' } : { borderColor: badge.color, boxShadow: `0 0 15px ${badge.color}40` }) : {}}>
                                    <div className={`w-full h-full rounded-full flex items-center justify-center ${isUnlocked && badge.color === '#fbbf24' ? 'bg-black' : ''}`}>
                                        {badge ? (isUnlocked ? <div className="w-10 h-10 md:w-12 md:h-12"><BadgeIcon badge={badge} assets={gameAssets} /></div> : <span className="font-retro text-gray-800 text-xl">?</span>) : <span className="text-gray-900 text-xs">EMPTY</span>}
                                    </div>
                                </div>
                                {badge && isUnlocked && <span className="text-[8px] font-mono text-center text-gray-400 w-full truncate px-1">{badge.score} PTS</span>}
                            </div>
                        );
                    })}
                </div>
            </div>
        </div>
      )}

      {/* --- SETTINGS MODAL --- */}
      {isSettingsOpen && (<SettingsPanel badges={badgeConfigs} weapons={weaponConfigs} onSave={handleSettingsSave} onClose={handleSettingsClose} />)}

      {/* --- EDITOR MODAL --- */}
      {isEditorOpen && (<PixelEditor currentAssets={gameAssets} onSave={handleEditorSave} onClose={handleEditorClose} />)}

      {/* --- HERO AREA (100vh) --- */}
      <div className="relative w-full h-screen overflow-hidden flex flex-col items-center justify-center">
        
        {/* === STAGE 0, 1, 2: 2D GAMEPLAY === */}
        <div className={`absolute inset-0 z-10 transition-opacity duration-500 ${heroStage === 3 ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}>
          {/* Filters for Stage 0 */}
          <div className={`absolute inset-0 z-40 pointer-events-none transition-all duration-1000 ${heroStage === 0 ? 'old-tv-filter scanline-heavy' : 'scanline opacity-30'}`}></div>
          <div className="absolute inset-0 crt-flicker bg-green-900/10 z-40 pointer-events-none"></div>
          
          <div className="w-full h-full relative pointer-events-auto game-cursor z-30 touch-pan-y" onPointerDown={handleGameInteraction}> 
            <canvas ref={canvasRef} className="w-full h-full block" />
            
            <div className={`absolute top-6 left-6 font-retro z-50 pointer-events-none select-none text-xs md:text-base ${heroStage === 0 ? 'text-gray-400' : 'text-green-400'}`}>
              <p>SCORE: {retroScore}</p>
              {heroStage === 0 && <p className="mt-2 text-[10px] text-gray-500">SYSTEM: LEGACY_MODE</p>}
              {heroStage > 0 && <p className="mt-2 text-[10px] text-cyan-400">SYSTEM: INTERACTIVE_MODE</p>}
              <p className="mt-2 text-[10px] md:text-xs animate-pulse flex items-center gap-2"><MousePointer2 className="w-3 h-3 md:w-4 md:h-4" /> TAP TO SHOOT</p>
            </div>
          </div>
        </div>

        {/* WEAPON BUTTONS (Stage 1+) - Bottom Right (Replaced with PixelButton) */}
        {heroStage === 1 && (
            <div className="absolute bottom-12 right-6 z-50 flex gap-4 pointer-events-auto animate-in slide-in-from-bottom duration-500">
                <PixelButton type="red" color="#ef4444" onClick={() => activatePowerUp('red')} active={weaponType === 'red'} />
                <PixelButton type="green" color="#22c55e" onClick={() => activatePowerUp('green')} active={weaponType === 'green'} />
                <PixelButton type="blue" color="#22d3ee" onClick={() => activatePowerUp('blue')} active={weaponType === 'blue'} />
                <PixelButton type="gold" color="#fbbf24" onClick={() => activatePowerUp('gold')} active={weaponType === 'gold'} />
            </div>
        )}

        {/* HUD - Only shows in Stage 1 & 2 */}
        {heroStage > 0 && heroStage < 3 && (
            <div className="fixed top-16 md:top-24 right-4 md:right-6 z-50 flex flex-col gap-2 md:gap-4 pointer-events-none transition-opacity duration-1000">
                <div className="bg-black/80 border border-gray-700 p-2 font-mono text-[10px] md:text-xs text-white mb-2 w-full text-right pointer-events-auto">
                    <div className="flex items-center justify-end gap-2 mb-1" style={{color: weaponConfigs[weaponType].color}}>
                        {weaponType === 'red' && <Flame className="w-4 h-4" />}
                        {weaponType === 'green' && <Biohazard className="w-4 h-4" />}
                        {weaponType === 'blue' && <Wind className="w-4 h-4" />}
                        {weaponType === 'gold' && <Zap className="w-4 h-4" />}
                        {weaponType === 'default' && <Disc className="w-4 h-4" />}
                        <span>{weaponConfigs[weaponType].name}</span>
                    </div>
                    <div>AMMO: {ammo === Infinity ? 'INF' : ammo}</div>
                    {isRedOverheated && <div className="text-red-500 animate-pulse">OVERHEAT!</div>}
                </div>

                {heroStage >= 1 && (
                    <div className="flex flex-col gap-3 pointer-events-auto animate-in slide-in-from-right duration-500 items-end">
                        <button onClick={handleOpenSettings} className="bg-cyan-900/80 border border-cyan-500 text-cyan-200 p-2 md:p-3 rounded-full hover:bg-cyan-500 hover:text-black transition-all shadow-[0_0_15px_rgba(34,211,238,0.4)] cursor-pointer flex items-center justify-center w-10 h-10 md:w-12 md:h-12"><Settings className="w-5 h-5 md:w-6 md:h-6" /></button>
                        <button onClick={handleOpenBadgeList} className="bg-yellow-900/80 border border-yellow-500 text-yellow-200 p-2 md:p-3 rounded-full hover:bg-yellow-500 hover:text-black transition-all shadow-[0_0_15px_rgba(234,179,8,0.4)] cursor-pointer flex items-center justify-center w-10 h-10 md:w-12 md:h-12"><Trophy className="w-5 h-5 md:w-6 md:h-6" /></button>
                        <button onClick={handleOpenEditor} className="bg-purple-900/80 border border-purple-500 text-purple-200 p-2 md:p-3 rounded-full hover:bg-purple-500 hover:text-black transition-all shadow-[0_0_15px_rgba(168,85,247,0.4)] cursor-pointer flex items-center justify-center group w-10 h-10 md:w-12 md:h-12">{isPaused && !showBadgeList && !newBadge && !isEditorOpen && !isSettingsOpen ? <Play className="w-5 h-5 md:w-6 md:h-6 fill-current" /> : <Edit className="w-5 h-5 md:w-6 md:h-6 group-hover:rotate-12 transition-transform" />}</button>
                    </div>
                )}
            </div>
        )}

        {/* === STAGE 3: FUTURE (Three.js) === */}
        <div className="absolute inset-0 z-30 transition-opacity duration-1000" style={{ opacity: heroStage === 3 ? 1 : 0, pointerEvents: heroStage === 3 ? 'auto' : 'none' }}>
            <ThreeScene active={heroStage === 3} triggerExplosion={aiTriggered} assets={gameAssets} />
            
            {/* AI Console */}
            <div className={`absolute inset-0 flex flex-col items-center justify-end pb-16 md:pb-24 transition-all duration-500 ${aiTriggered ? 'opacity-0' : 'opacity-100'}`}>
                <div className="bg-black/80 backdrop-blur-md border border-green-500/50 p-4 md:p-6 rounded-sm w-[90%] max-w-lg shadow-[0_0_30px_rgba(34,197,94,0.2)]">
                    <div className="flex items-center justify-between mb-2 md:mb-4 border-b border-green-500/30 pb-2">
                        <div className="flex items-center space-x-2"><Terminal className="w-4 h-4 md:w-5 md:h-5 text-green-500" /><span className="font-retro text-[10px] md:text-xs text-green-400">FAW_LABS_AI_AGENT v3.0</span></div>
                        <div className="flex space-x-1"><div className="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div><span className="text-[10px] md:text-xs text-red-400 font-mono">THREAT DETECTED</span></div>
                    </div>
                    <div className="font-mono text-green-300 text-xs md:text-sm mb-4 md:mb-6 space-y-1">
                        <p>{'>'} Analysis: BRAND_EVOLUTION_COMPLETE</p>
                        <p>{'>'} Ready to deploy next-gen visuals.</p>
                        <p className="animate-pulse">{'>'} AWAITING EXECUTION_</p>
                    </div>
                    <button onClick={handleAiExecute} className="w-full group relative overflow-hidden bg-green-900/20 border border-green-500 hover:bg-green-500/20 text-green-400 hover:text-green-200 transition-all duration-300 py-3 md:py-4 font-tech font-bold text-lg md:text-xl uppercase tracking-widest cursor-pointer">
                        <span className="relative z-10 flex items-center justify-center space-x-3"><Cpu className="w-5 h-5 md:w-6 md:h-6" /><span>Execute_AI_Agent</span></span>
                        <div className="absolute inset-0 bg-green-500/10 transform -translate-x-full group-hover:translate-x-0 transition-transform duration-300"></div>
                    </button>
                </div>
            </div>

            {/* Final CTA */}
            <div className={`absolute inset-0 flex items-center justify-center pointer-events-none transition-all duration-1000 ${aiTriggered ? 'opacity-100 scale-100' : 'opacity-0 scale-150'}`}>
                <div className="text-center font-tech px-4">
                    <h1 className="text-4xl md:text-7xl font-bold text-cyan-400 drop-shadow-[0_0_20px_rgba(34,211,238,0.8)] glitch-text" data-text="FUTURE READY">FUTURE<br/>READY</h1>
                    <p className="mt-4 md:mt-6 text-sm md:text-xl text-white font-mono tracking-widest bg-black/60 inline-block px-4 py-1">WE BUILD INTERACTIVE BRANDS</p>
                    <div className="mt-8 md:mt-12 flex flex-col md:flex-row justify-center gap-4">
                        <button className="px-8 py-4 bg-white text-black font-bold hover:bg-cyan-400 hover:text-black transition-colors pointer-events-auto cursor-pointer text-sm md:text-lg tracking-widest uppercase flex items-center justify-center gap-2">
                             CONTACT US <ArrowDown className="w-4 h-4" />
                        </button>
                        <button onClick={() => window.location.reload()} className="px-8 py-4 border border-white text-white hover:bg-white/10 transition-colors pointer-events-auto cursor-pointer text-sm md:text-lg tracking-widest uppercase">
                            REPLAY DEMO
                        </button>
                    </div>
                </div>
            </div>
        </div>
      </div>

      {/* --- CONTENT SECTIONS (Scroll Down) --- */}
      <div className="relative z-10 bg-black">
        {/* Unit 2: Brand Experience */}
        <div className="min-h-screen border-t border-gray-800 flex items-center justify-center p-8">
            <div className="max-w-4xl text-center">
                <Shield className="w-16 h-16 text-cyan-500 mx-auto mb-6" />
                <h2 className="text-4xl font-bold mb-4 font-tech text-white">BRAND EXPERIENCE</h2>
                <p className="text-gray-400 leading-relaxed">We create memorable moments that stick.</p>
            </div>
        </div>

        {/* Unit 3: AI Lab */}
        <div className="min-h-screen border-t border-gray-800 flex items-center justify-center p-8 bg-gray-900/30">
            <div className="max-w-4xl text-center">
                <Cpu className="w-16 h-16 text-green-500 mx-auto mb-6" />
                <h2 className="text-4xl font-bold mb-4 font-tech text-white">AI LABORATORY</h2>
                <p className="text-gray-400 leading-relaxed">Leveraging the latest in generative technology.</p>
            </div>
        </div>
      </div>
    </div>
  );
}